@namespace Blazor.DesignSystem.Components

<div class="govuk-form-group @(HasError ? "govuk-form-group--error" : "") @CssClass">
    <fieldset class="govuk-fieldset" aria-describedby="@GetAriaDescribedBy()">
        @if (!string.IsNullOrWhiteSpace(Legend))
        {
            <legend class="govuk-fieldset__legend @LegendCssClass">
                @if (IsPageHeading)
                {
                    <h1 class="govuk-fieldset__heading">
                        @Legend
                    </h1>
                }
                else
                {
                    @Legend
                }
            </legend>
        }
        @if (!string.IsNullOrWhiteSpace(Hint))
        {
            <div id="@(Name)-hint" class="govuk-hint">
                @Hint
            </div>
        }
        @if (HasError && !string.IsNullOrWhiteSpace(ErrorMessage))
        {
            <p id="@(Name)-error" class="govuk-error-message">
                <span class="govuk-visually-hidden">@ErrorMessageVisuallyHiddenText:</span> @ErrorMessage
            </p>
        }
        <div class="govuk-radios @(IsSmall ? "govuk-radios--small" : "") @(IsInline ? "govuk-radios--inline" : "")" data-module="govuk-radios">
            <CascadingValue Value="this">
                @ChildContent
            </CascadingValue>
        </div>
    </fieldset>
</div>

@code {
    /// <summary>
    /// The name attribute for the radio group.
    /// </summary>
    [Parameter, EditorRequired]
    public string Name { get; set; } = string.Empty;

    /// <summary>
    /// The legend text for the fieldset.
    /// </summary>
    [Parameter]
    public string? Legend { get; set; }

    /// <summary>
    /// Additional CSS classes for the legend.
    /// </summary>
    [Parameter]
    public string? LegendCssClass { get; set; }

    /// <summary>
    /// Whether the legend should be styled as a page heading.
    /// </summary>
    [Parameter]
    public bool IsPageHeading { get; set; }

    /// <summary>
    /// Hint text to display below the legend.
    /// </summary>
    [Parameter]
    public string? Hint { get; set; }

    /// <summary>
    /// Whether the field has an error.
    /// </summary>
    [Parameter]
    public bool HasError { get; set; }

    /// <summary>
    /// The error message to display.
    /// </summary>
    [Parameter]
    public string? ErrorMessage { get; set; }

    /// <summary>
    /// The visually hidden text before the error message. Defaults to "Error".
    /// </summary>
    [Parameter]
    public string ErrorMessageVisuallyHiddenText { get; set; } = "Error";

    /// <summary>
    /// Whether to use smaller radios.
    /// </summary>
    [Parameter]
    public bool IsSmall { get; set; }

    /// <summary>
    /// Whether to display radios inline.
    /// </summary>
    [Parameter]
    public bool IsInline { get; set; }

    /// <summary>
    /// Additional CSS classes to apply.
    /// </summary>
    [Parameter]
    public string? CssClass { get; set; }

    /// <summary>
    /// The radio items (should be GovUkRadioItem components).
    /// </summary>
    [Parameter]
    public RenderFragment? ChildContent { get; set; }

    /// <summary>
    /// The selected value.
    /// </summary>
    [Parameter]
    public string? SelectedValue { get; set; }

    /// <summary>
    /// Callback for when the selected value changes.
    /// </summary>
    [Parameter]
    public EventCallback<string?> SelectedValueChanged { get; set; }

    internal bool IsSelected(string value)
    {
        return SelectedValue == value;
    }

    internal async Task SelectValue(string value)
    {
        SelectedValue = value;
        await SelectedValueChanged.InvokeAsync(SelectedValue);
        StateHasChanged();
    }

    private string? GetAriaDescribedBy()
    {
        var parts = new List<string>();
        
        if (!string.IsNullOrWhiteSpace(Hint))
        {
            parts.Add($"{Name}-hint");
        }
        
        if (HasError && !string.IsNullOrWhiteSpace(ErrorMessage))
        {
            parts.Add($"{Name}-error");
        }
        
        return parts.Count > 0 ? string.Join(" ", parts) : null;
    }
}
