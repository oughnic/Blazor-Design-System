@namespace Blazor.DesignSystem.Components

<div class="govuk-form-group @(HasError ? "govuk-form-group--error" : "") @CssClass">
    @if (!string.IsNullOrWhiteSpace(Label))
    {
        <label class="govuk-label @LabelCssClass" for="@Id">
            @Label
        </label>
    }
    @if (!string.IsNullOrWhiteSpace(Hint))
    {
        <div id="@(Id)-hint" class="govuk-hint">
            @Hint
        </div>
    }
    @if (HasError && !string.IsNullOrWhiteSpace(ErrorMessage))
    {
        <p id="@(Id)-error" class="govuk-error-message">
            <span class="govuk-visually-hidden">Error:</span> @ErrorMessage
        </p>
    }
    <textarea class="govuk-textarea @(HasError ? "govuk-textarea--error" : "") @TextareaCssClass" 
              id="@Id" 
              name="@Name" 
              rows="@Rows"
              disabled="@Disabled"
              aria-describedby="@GetAriaDescribedBy()"
              autocomplete="@Autocomplete"
              spellcheck="@(Spellcheck.HasValue ? Spellcheck.Value.ToString().ToLower() : null)"
              @oninput="HandleInput"
              @attributes="AdditionalAttributes">@Value</textarea>
</div>

@code {
    /// <summary>
    /// The unique identifier for the textarea.
    /// </summary>
    [Parameter]
    public string Id { get; set; } = $"textarea-{Guid.NewGuid():N}";

    /// <summary>
    /// The name attribute for the textarea.
    /// </summary>
    [Parameter]
    public string? Name { get; set; }

    /// <summary>
    /// The label text for the textarea.
    /// </summary>
    [Parameter]
    public string? Label { get; set; }

    /// <summary>
    /// Additional CSS classes for the label.
    /// </summary>
    [Parameter]
    public string? LabelCssClass { get; set; }

    /// <summary>
    /// Hint text to display below the label.
    /// </summary>
    [Parameter]
    public string? Hint { get; set; }

    /// <summary>
    /// The number of rows for the textarea.
    /// </summary>
    [Parameter]
    public int Rows { get; set; } = 5;

    /// <summary>
    /// The current value of the textarea.
    /// </summary>
    [Parameter]
    public string? Value { get; set; }

    /// <summary>
    /// Callback for when the value changes.
    /// </summary>
    [Parameter]
    public EventCallback<string?> ValueChanged { get; set; }

    /// <summary>
    /// Whether the textarea is disabled.
    /// </summary>
    [Parameter]
    public bool Disabled { get; set; }

    /// <summary>
    /// Whether the field has an error.
    /// </summary>
    [Parameter]
    public bool HasError { get; set; }

    /// <summary>
    /// The error message to display.
    /// </summary>
    [Parameter]
    public string? ErrorMessage { get; set; }

    /// <summary>
    /// The autocomplete attribute value.
    /// </summary>
    [Parameter]
    public string? Autocomplete { get; set; }

    /// <summary>
    /// The spellcheck attribute value.
    /// </summary>
    [Parameter]
    public bool? Spellcheck { get; set; }

    /// <summary>
    /// Additional CSS classes to apply to the form group.
    /// </summary>
    [Parameter]
    public string? CssClass { get; set; }

    /// <summary>
    /// Additional CSS classes to apply to the textarea.
    /// </summary>
    [Parameter]
    public string? TextareaCssClass { get; set; }

    /// <summary>
    /// Additional HTML attributes to apply to the textarea.
    /// </summary>
    [Parameter(CaptureUnmatchedValues = true)]
    public Dictionary<string, object>? AdditionalAttributes { get; set; }

    private async Task HandleInput(ChangeEventArgs e)
    {
        Value = e.Value?.ToString();
        await ValueChanged.InvokeAsync(Value);
    }

    private string? GetAriaDescribedBy()
    {
        var parts = new List<string>();
        
        if (!string.IsNullOrWhiteSpace(Hint))
        {
            parts.Add($"{Id}-hint");
        }
        
        if (HasError && !string.IsNullOrWhiteSpace(ErrorMessage))
        {
            parts.Add($"{Id}-error");
        }
        
        return parts.Count > 0 ? string.Join(" ", parts) : null;
    }
}
