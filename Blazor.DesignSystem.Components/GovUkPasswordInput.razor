@namespace Blazor.DesignSystem.Components
@inject IJSRuntime JSRuntime

<div class="govuk-form-group govuk-password-input @(HasError ? "govuk-form-group--error" : "") @CssClass" 
     data-module="govuk-password-input"
     @attributes="AdditionalAttributes">
    @if (!string.IsNullOrWhiteSpace(Label))
    {
        <label class="govuk-label @LabelCssClass" for="@Id">
            @Label
        </label>
    }
    @if (!string.IsNullOrWhiteSpace(Hint))
    {
        <div id="@(Id)-hint" class="govuk-hint">
            @Hint
        </div>
    }
    @if (HasError && !string.IsNullOrWhiteSpace(ErrorMessage))
    {
        <p id="@(Id)-error" class="govuk-error-message">
            <span class="govuk-visually-hidden">@ErrorMessageVisuallyHiddenText:</span> @ErrorMessage
        </p>
    }
    <div class="govuk-input__wrapper govuk-password-input__wrapper">
        <input class="govuk-input govuk-password-input__input govuk-js-password-input-input @(HasError ? "govuk-input--error" : "") @InputCssClass" 
               id="@Id" 
               name="@Name" 
               type="@(_showPassword ? "text" : "password")"
               value="@Value"
               disabled="@Disabled"
               aria-describedby="@GetAriaDescribedBy()"
               aria-invalid="@(HasError ? "true" : null)"
               autocomplete="@(Autocomplete ?? "current-password")"
               autocapitalize="none"
               spellcheck="false"
               @oninput="HandleInput">
        <button type="button"
                class="govuk-button govuk-button--secondary govuk-password-input__toggle govuk-js-password-input-toggle @ButtonCssClass"
                aria-controls="@Id"
                aria-label="@(_showPassword ? HidePasswordAriaLabelText : ShowPasswordAriaLabelText)"
                @onclick="TogglePasswordVisibility">
            @(_showPassword ? HidePasswordText : ShowPasswordText)
        </button>
    </div>
    @* Screen reader announcement element *@
    <div class="govuk-visually-hidden" aria-live="polite">
        @_announcement
    </div>
</div>

@code {
    private bool _showPassword = false;
    private string _announcement = "";

    /// <summary>
    /// The unique identifier for the input.
    /// </summary>
    [Parameter]
    public string Id { get; set; } = $"password-input-{Guid.NewGuid():N}";

    /// <summary>
    /// The name attribute for the input.
    /// </summary>
    [Parameter]
    public string? Name { get; set; }

    /// <summary>
    /// The label text for the input.
    /// </summary>
    [Parameter]
    public string? Label { get; set; }

    /// <summary>
    /// Additional CSS classes for the label.
    /// </summary>
    [Parameter]
    public string? LabelCssClass { get; set; }

    /// <summary>
    /// Hint text to display below the label.
    /// </summary>
    [Parameter]
    public string? Hint { get; set; }

    /// <summary>
    /// The current value of the input.
    /// </summary>
    [Parameter]
    public string? Value { get; set; }

    /// <summary>
    /// Callback for when the value changes.
    /// </summary>
    [Parameter]
    public EventCallback<string?> ValueChanged { get; set; }

    /// <summary>
    /// Whether the input is disabled.
    /// </summary>
    [Parameter]
    public bool Disabled { get; set; }

    /// <summary>
    /// Whether the field has an error.
    /// </summary>
    [Parameter]
    public bool HasError { get; set; }

    /// <summary>
    /// The error message to display.
    /// </summary>
    [Parameter]
    public string? ErrorMessage { get; set; }

    /// <summary>
    /// The visually hidden text before the error message. Defaults to "Error".
    /// </summary>
    [Parameter]
    public string ErrorMessageVisuallyHiddenText { get; set; } = "Error";

    /// <summary>
    /// The autocomplete attribute value. Defaults to "current-password".
    /// </summary>
    [Parameter]
    public string? Autocomplete { get; set; }

    /// <summary>
    /// Additional CSS classes to apply to the form group.
    /// </summary>
    [Parameter]
    public string? CssClass { get; set; }

    /// <summary>
    /// Additional CSS classes to apply to the input.
    /// </summary>
    [Parameter]
    public string? InputCssClass { get; set; }

    /// <summary>
    /// Additional CSS classes to apply to the toggle button.
    /// </summary>
    [Parameter]
    public string? ButtonCssClass { get; set; }

    /// <summary>
    /// Text for the "Show password" button. Defaults to "Show".
    /// </summary>
    [Parameter]
    public string ShowPasswordText { get; set; } = "Show";

    /// <summary>
    /// Text for the "Hide password" button. Defaults to "Hide".
    /// </summary>
    [Parameter]
    public string HidePasswordText { get; set; } = "Hide";

    /// <summary>
    /// Aria label for the "Show password" button. Defaults to "Show password".
    /// </summary>
    [Parameter]
    public string ShowPasswordAriaLabelText { get; set; } = "Show password";

    /// <summary>
    /// Aria label for the "Hide password" button. Defaults to "Hide password".
    /// </summary>
    [Parameter]
    public string HidePasswordAriaLabelText { get; set; } = "Hide password";

    /// <summary>
    /// Screen reader announcement when password is shown. Defaults to "Your password is visible".
    /// </summary>
    [Parameter]
    public string PasswordShownAnnouncementText { get; set; } = "Your password is visible";

    /// <summary>
    /// Screen reader announcement when password is hidden. Defaults to "Your password is hidden".
    /// </summary>
    [Parameter]
    public string PasswordHiddenAnnouncementText { get; set; } = "Your password is hidden";

    /// <summary>
    /// Additional HTML attributes to apply to the input.
    /// </summary>
    [Parameter(CaptureUnmatchedValues = true)]
    public Dictionary<string, object>? AdditionalAttributes { get; set; }

    private async Task HandleInput(ChangeEventArgs e)
    {
        Value = e.Value?.ToString();
        await ValueChanged.InvokeAsync(Value);
    }

    private void TogglePasswordVisibility()
    {
        _showPassword = !_showPassword;
        _announcement = _showPassword ? PasswordShownAnnouncementText : PasswordHiddenAnnouncementText;
    }

    private string? GetAriaDescribedBy()
    {
        var parts = new List<string>();
        
        if (!string.IsNullOrWhiteSpace(Hint))
        {
            parts.Add($"{Id}-hint");
        }
        
        if (HasError && !string.IsNullOrWhiteSpace(ErrorMessage))
        {
            parts.Add($"{Id}-error");
        }
        
        return parts.Count > 0 ? string.Join(" ", parts) : null;
    }
}
