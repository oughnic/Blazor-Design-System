@namespace Blazor.DesignSystem.Components

<div class="govuk-form-group @(HasError ? "govuk-form-group--error" : "") @CssClass">
    @if (!string.IsNullOrWhiteSpace(Label))
    {
        <label class="govuk-label @LabelCssClass" for="@Id">
            @Label
        </label>
    }
    @if (!string.IsNullOrWhiteSpace(Hint))
    {
        <div id="@(Id)-hint" class="govuk-hint">
            @Hint
        </div>
    }
    @if (HasError && !string.IsNullOrWhiteSpace(ErrorMessage))
    {
        <p id="@(Id)-error" class="govuk-error-message">
            <span class="govuk-visually-hidden">@ErrorMessageVisuallyHiddenText:</span> @ErrorMessage
        </p>
    }
    <select class="govuk-select @(HasError ? "govuk-select--error" : "") @SelectCssClass" 
            id="@Id" 
            name="@Name"
            disabled="@Disabled"
            aria-describedby="@GetAriaDescribedBy()"
            aria-invalid="@(HasError ? "true" : null)"
            @onchange="HandleChange"
            @attributes="AdditionalAttributes">
        @ChildContent
    </select>
</div>

@code {
    /// <summary>
    /// The unique identifier for the select.
    /// </summary>
    [Parameter]
    public string Id { get; set; } = $"select-{Guid.NewGuid():N}";

    /// <summary>
    /// The name attribute for the select.
    /// </summary>
    [Parameter]
    public string? Name { get; set; }

    /// <summary>
    /// The label text for the select.
    /// </summary>
    [Parameter]
    public string? Label { get; set; }

    /// <summary>
    /// Additional CSS classes for the label.
    /// </summary>
    [Parameter]
    public string? LabelCssClass { get; set; }

    /// <summary>
    /// Hint text to display below the label.
    /// </summary>
    [Parameter]
    public string? Hint { get; set; }

    /// <summary>
    /// The currently selected value.
    /// </summary>
    [Parameter]
    public string? Value { get; set; }

    /// <summary>
    /// Callback for when the value changes.
    /// </summary>
    [Parameter]
    public EventCallback<string?> ValueChanged { get; set; }

    /// <summary>
    /// Whether the select is disabled.
    /// </summary>
    [Parameter]
    public bool Disabled { get; set; }

    /// <summary>
    /// Whether the field has an error.
    /// </summary>
    [Parameter]
    public bool HasError { get; set; }

    /// <summary>
    /// The error message to display.
    /// </summary>
    [Parameter]
    public string? ErrorMessage { get; set; }

    /// <summary>
    /// The visually hidden text before the error message. Defaults to "Error".
    /// </summary>
    [Parameter]
    public string ErrorMessageVisuallyHiddenText { get; set; } = "Error";

    /// <summary>
    /// The select options (should contain option elements).
    /// </summary>
    [Parameter]
    public RenderFragment? ChildContent { get; set; }

    /// <summary>
    /// Additional CSS classes to apply to the form group.
    /// </summary>
    [Parameter]
    public string? CssClass { get; set; }

    /// <summary>
    /// Additional CSS classes to apply to the select.
    /// </summary>
    [Parameter]
    public string? SelectCssClass { get; set; }

    /// <summary>
    /// Additional HTML attributes to apply to the select.
    /// </summary>
    [Parameter(CaptureUnmatchedValues = true)]
    public Dictionary<string, object>? AdditionalAttributes { get; set; }

    private async Task HandleChange(ChangeEventArgs e)
    {
        Value = e.Value?.ToString();
        await ValueChanged.InvokeAsync(Value);
    }

    private string? GetAriaDescribedBy()
    {
        var parts = new List<string>();
        
        if (!string.IsNullOrWhiteSpace(Hint))
        {
            parts.Add($"{Id}-hint");
        }
        
        if (HasError && !string.IsNullOrWhiteSpace(ErrorMessage))
        {
            parts.Add($"{Id}-error");
        }
        
        return parts.Count > 0 ? string.Join(" ", parts) : null;
    }
}
