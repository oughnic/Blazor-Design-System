@namespace Blazor.DesignSystem.Components

<div class="govuk-form-group @(HasError ? "govuk-form-group--error" : "") @CssClass">
    <fieldset class="govuk-fieldset" aria-describedby="@GetAriaDescribedBy()" role="group">
        @if (!string.IsNullOrWhiteSpace(Legend))
        {
            <legend class="govuk-fieldset__legend @LegendCssClass">
                @if (IsPageHeading)
                {
                    <h1 class="govuk-fieldset__heading">
                        @Legend
                    </h1>
                }
                else
                {
                    @Legend
                }
            </legend>
        }
        @if (!string.IsNullOrWhiteSpace(Hint))
        {
            <div id="@(Id)-hint" class="govuk-hint">
                @Hint
            </div>
        }
        @if (HasError && !string.IsNullOrWhiteSpace(ErrorMessage))
        {
            <p id="@(Id)-error" class="govuk-error-message">
                <span class="govuk-visually-hidden">@ErrorMessageVisuallyHiddenText:</span> @ErrorMessage
            </p>
        }
        <div class="govuk-date-input" id="@Id">
            <div class="govuk-date-input__item">
                <div class="govuk-form-group">
                    <label class="govuk-label govuk-date-input__label" for="@(Id)-day">
                        @DayLabel
                    </label>
                    <input class="govuk-input govuk-date-input__input govuk-input--width-2 @(HasDayError ? "govuk-input--error" : "")" 
                           id="@(Id)-day" 
                           name="@(Name ?? Id)-day" 
                           type="text"
                           inputmode="numeric"
                           pattern="[0-9]*"
                           autocomplete="@(DayAutocomplete ?? Autocomplete)"
                           value="@Day"
                           @oninput="HandleDayInput">
                </div>
            </div>
            <div class="govuk-date-input__item">
                <div class="govuk-form-group">
                    <label class="govuk-label govuk-date-input__label" for="@(Id)-month">
                        @MonthLabel
                    </label>
                    <input class="govuk-input govuk-date-input__input govuk-input--width-2 @(HasMonthError ? "govuk-input--error" : "")" 
                           id="@(Id)-month" 
                           name="@(Name ?? Id)-month" 
                           type="text"
                           inputmode="numeric"
                           pattern="[0-9]*"
                           autocomplete="@(MonthAutocomplete ?? Autocomplete)"
                           value="@Month"
                           @oninput="HandleMonthInput">
                </div>
            </div>
            <div class="govuk-date-input__item">
                <div class="govuk-form-group">
                    <label class="govuk-label govuk-date-input__label" for="@(Id)-year">
                        @YearLabel
                    </label>
                    <input class="govuk-input govuk-date-input__input govuk-input--width-4 @(HasYearError ? "govuk-input--error" : "")" 
                           id="@(Id)-year" 
                           name="@(Name ?? Id)-year" 
                           type="text"
                           inputmode="numeric"
                           pattern="[0-9]*"
                           autocomplete="@(YearAutocomplete ?? Autocomplete)"
                           value="@Year"
                           @oninput="HandleYearInput">
                </div>
            </div>
        </div>
    </fieldset>
</div>

@code {
    /// <summary>
    /// The unique identifier for the date input.
    /// </summary>
    [Parameter]
    public string Id { get; set; } = $"date-input-{Guid.NewGuid():N}";

    /// <summary>
    /// The name attribute prefix for the date inputs.
    /// </summary>
    [Parameter]
    public string? Name { get; set; }

    /// <summary>
    /// The legend text for the fieldset.
    /// </summary>
    [Parameter]
    public string? Legend { get; set; }

    /// <summary>
    /// Additional CSS classes for the legend.
    /// </summary>
    [Parameter]
    public string? LegendCssClass { get; set; }

    /// <summary>
    /// Whether the legend should be styled as a page heading.
    /// </summary>
    [Parameter]
    public bool IsPageHeading { get; set; }

    /// <summary>
    /// Hint text to display below the legend.
    /// </summary>
    [Parameter]
    public string? Hint { get; set; }

    /// <summary>
    /// The day value.
    /// </summary>
    [Parameter]
    public string? Day { get; set; }

    /// <summary>
    /// Callback for when the day changes.
    /// </summary>
    [Parameter]
    public EventCallback<string?> DayChanged { get; set; }

    /// <summary>
    /// The month value.
    /// </summary>
    [Parameter]
    public string? Month { get; set; }

    /// <summary>
    /// Callback for when the month changes.
    /// </summary>
    [Parameter]
    public EventCallback<string?> MonthChanged { get; set; }

    /// <summary>
    /// The year value.
    /// </summary>
    [Parameter]
    public string? Year { get; set; }

    /// <summary>
    /// Callback for when the year changes.
    /// </summary>
    [Parameter]
    public EventCallback<string?> YearChanged { get; set; }

    /// <summary>
    /// Whether the entire date field has an error.
    /// </summary>
    [Parameter]
    public bool HasError { get; set; }

    /// <summary>
    /// Whether the day field specifically has an error.
    /// When true, applies error styling only to the day input.
    /// When HasError is true and this is not set, all fields get error styling.
    /// </summary>
    [Parameter]
    public bool? HasDayFieldError { get; set; }

    /// <summary>
    /// Whether the month field specifically has an error.
    /// When true, applies error styling only to the month input.
    /// When HasError is true and this is not set, all fields get error styling.
    /// </summary>
    [Parameter]
    public bool? HasMonthFieldError { get; set; }

    /// <summary>
    /// Whether the year field specifically has an error.
    /// When true, applies error styling only to the year input.
    /// When HasError is true and this is not set, all fields get error styling.
    /// </summary>
    [Parameter]
    public bool? HasYearFieldError { get; set; }

    /// <summary>
    /// The error message to display.
    /// </summary>
    [Parameter]
    public string? ErrorMessage { get; set; }

    /// <summary>
    /// The visually hidden text before the error message. Defaults to "Error".
    /// </summary>
    [Parameter]
    public string ErrorMessageVisuallyHiddenText { get; set; } = "Error";

    /// <summary>
    /// Label for the day field. Defaults to "Day".
    /// </summary>
    [Parameter]
    public string DayLabel { get; set; } = "Day";

    /// <summary>
    /// Label for the month field. Defaults to "Month".
    /// </summary>
    [Parameter]
    public string MonthLabel { get; set; } = "Month";

    /// <summary>
    /// Label for the year field. Defaults to "Year".
    /// </summary>
    [Parameter]
    public string YearLabel { get; set; } = "Year";

    /// <summary>
    /// Autocomplete value for all date fields.
    /// </summary>
    [Parameter]
    public string? Autocomplete { get; set; }

    /// <summary>
    /// Autocomplete value specifically for the day field.
    /// </summary>
    [Parameter]
    public string? DayAutocomplete { get; set; }

    /// <summary>
    /// Autocomplete value specifically for the month field.
    /// </summary>
    [Parameter]
    public string? MonthAutocomplete { get; set; }

    /// <summary>
    /// Autocomplete value specifically for the year field.
    /// </summary>
    [Parameter]
    public string? YearAutocomplete { get; set; }

    /// <summary>
    /// Additional CSS classes to apply to the form group.
    /// </summary>
    [Parameter]
    public string? CssClass { get; set; }

    // Computed error state for individual fields
    private bool HasDayError => HasDayFieldError ?? (HasError && !HasMonthFieldError.HasValue && !HasYearFieldError.HasValue);
    private bool HasMonthError => HasMonthFieldError ?? (HasError && !HasDayFieldError.HasValue && !HasYearFieldError.HasValue);
    private bool HasYearError => HasYearFieldError ?? (HasError && !HasDayFieldError.HasValue && !HasMonthFieldError.HasValue);

    private async Task HandleDayInput(ChangeEventArgs e)
    {
        Day = e.Value?.ToString();
        await DayChanged.InvokeAsync(Day);
    }

    private async Task HandleMonthInput(ChangeEventArgs e)
    {
        Month = e.Value?.ToString();
        await MonthChanged.InvokeAsync(Month);
    }

    private async Task HandleYearInput(ChangeEventArgs e)
    {
        Year = e.Value?.ToString();
        await YearChanged.InvokeAsync(Year);
    }

    private string? GetAriaDescribedBy()
    {
        var parts = new List<string>();
        
        if (!string.IsNullOrWhiteSpace(Hint))
        {
            parts.Add($"{Id}-hint");
        }
        
        if (HasError && !string.IsNullOrWhiteSpace(ErrorMessage))
        {
            parts.Add($"{Id}-error");
        }
        
        return parts.Count > 0 ? string.Join(" ", parts) : null;
    }
}
