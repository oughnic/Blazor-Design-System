@namespace Blazor.DesignSystem.Components

<div class="govuk-form-group @(HasError ? "govuk-form-group--error" : "") @CssClass">
    @if (!string.IsNullOrWhiteSpace(Label))
    {
        <label class="govuk-label @LabelCssClass" for="@Id">
            @Label
        </label>
    }
    @if (!string.IsNullOrWhiteSpace(Hint))
    {
        <div id="@(Id)-hint" class="govuk-hint">
            @Hint
        </div>
    }
    @if (HasError && !string.IsNullOrWhiteSpace(ErrorMessage))
    {
        <p id="@(Id)-error" class="govuk-error-message">
            <span class="govuk-visually-hidden">Error:</span> @ErrorMessage
        </p>
    }
    <input class="govuk-input @GetWidthClass() @(HasError ? "govuk-input--error" : "") @InputCssClass" 
           id="@Id" 
           name="@Name" 
           type="@Type"
           value="@Value"
           disabled="@Disabled"
           aria-describedby="@GetAriaDescribedBy()"
           autocomplete="@Autocomplete"
           inputmode="@InputMode"
           pattern="@Pattern"
           spellcheck="@(Spellcheck.HasValue ? Spellcheck.Value.ToString().ToLower() : null)"
           @oninput="HandleInput"
           @attributes="AdditionalAttributes">
</div>

@code {
    /// <summary>
    /// The unique identifier for the input.
    /// </summary>
    [Parameter]
    public string Id { get; set; } = $"input-{Guid.NewGuid():N}";

    /// <summary>
    /// The name attribute for the input.
    /// </summary>
    [Parameter]
    public string? Name { get; set; }

    /// <summary>
    /// The input type (e.g., "text", "email", "number").
    /// </summary>
    [Parameter]
    public string Type { get; set; } = "text";

    /// <summary>
    /// The label text for the input.
    /// </summary>
    [Parameter]
    public string? Label { get; set; }

    /// <summary>
    /// Additional CSS classes for the label.
    /// </summary>
    [Parameter]
    public string? LabelCssClass { get; set; }

    /// <summary>
    /// Hint text to display below the label.
    /// </summary>
    [Parameter]
    public string? Hint { get; set; }

    /// <summary>
    /// The current value of the input.
    /// </summary>
    [Parameter]
    public string? Value { get; set; }

    /// <summary>
    /// Callback for when the value changes.
    /// </summary>
    [Parameter]
    public EventCallback<string?> ValueChanged { get; set; }

    /// <summary>
    /// Whether the input is disabled.
    /// </summary>
    [Parameter]
    public bool Disabled { get; set; }

    /// <summary>
    /// Whether the field has an error.
    /// </summary>
    [Parameter]
    public bool HasError { get; set; }

    /// <summary>
    /// The error message to display.
    /// </summary>
    [Parameter]
    public string? ErrorMessage { get; set; }

    /// <summary>
    /// The width of the input (e.g., "20", "10", "5", "4", "3", "2", "full", "three-quarters", "two-thirds", "one-half", "one-third", "one-quarter").
    /// </summary>
    [Parameter]
    public string? Width { get; set; }

    /// <summary>
    /// The autocomplete attribute value.
    /// </summary>
    [Parameter]
    public string? Autocomplete { get; set; }

    /// <summary>
    /// The inputmode attribute value.
    /// </summary>
    [Parameter]
    public string? InputMode { get; set; }

    /// <summary>
    /// The pattern attribute value.
    /// </summary>
    [Parameter]
    public string? Pattern { get; set; }

    /// <summary>
    /// The spellcheck attribute value.
    /// </summary>
    [Parameter]
    public bool? Spellcheck { get; set; }

    /// <summary>
    /// Additional CSS classes to apply to the form group.
    /// </summary>
    [Parameter]
    public string? CssClass { get; set; }

    /// <summary>
    /// Additional CSS classes to apply to the input.
    /// </summary>
    [Parameter]
    public string? InputCssClass { get; set; }

    /// <summary>
    /// Additional HTML attributes to apply to the input.
    /// </summary>
    [Parameter(CaptureUnmatchedValues = true)]
    public Dictionary<string, object>? AdditionalAttributes { get; set; }

    private async Task HandleInput(ChangeEventArgs e)
    {
        Value = e.Value?.ToString();
        await ValueChanged.InvokeAsync(Value);
    }

    private string? GetWidthClass()
    {
        if (string.IsNullOrWhiteSpace(Width))
            return null;

        // Check if it's a numeric width (character width)
        if (int.TryParse(Width, out _))
        {
            return $"govuk-input--width-{Width}";
        }

        // Otherwise it's a fluid width
        return $"govuk-!-width-{Width}";
    }

    private string? GetAriaDescribedBy()
    {
        var parts = new List<string>();
        
        if (!string.IsNullOrWhiteSpace(Hint))
        {
            parts.Add($"{Id}-hint");
        }
        
        if (HasError && !string.IsNullOrWhiteSpace(ErrorMessage))
        {
            parts.Add($"{Id}-error");
        }
        
        return parts.Count > 0 ? string.Join(" ", parts) : null;
    }
}
