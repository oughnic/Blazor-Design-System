@namespace Blazor.DesignSystem.Components

<div class="govuk-form-group @(HasError ? "govuk-form-group--error" : "") @CssClass">
    @if (!string.IsNullOrWhiteSpace(Label))
    {
        <label class="govuk-label @LabelCssClass" for="@Id">
            @Label
        </label>
    }
    @if (!string.IsNullOrWhiteSpace(Hint))
    {
        <div id="@(Id)-hint" class="govuk-hint">
            @Hint
        </div>
    }
    @if (HasError && !string.IsNullOrWhiteSpace(ErrorMessage))
    {
        <p id="@(Id)-error" class="govuk-error-message">
            <span class="govuk-visually-hidden">@ErrorMessageVisuallyHiddenText:</span> @ErrorMessage
        </p>
    }
    <input class="govuk-file-upload @(HasError ? "govuk-file-upload--error" : "") @InputCssClass" 
           id="@Id" 
           name="@Name" 
           type="file"
           disabled="@Disabled"
           accept="@Accept"
           multiple="@Multiple"
           aria-describedby="@GetAriaDescribedBy()"
           aria-invalid="@(HasError ? "true" : null)"
           @onchange="HandleChange"
           @attributes="AdditionalAttributes">
</div>

@code {
    /// <summary>
    /// The unique identifier for the file upload.
    /// </summary>
    [Parameter]
    public string Id { get; set; } = $"file-upload-{Guid.NewGuid():N}";

    /// <summary>
    /// The name attribute for the file input.
    /// </summary>
    [Parameter]
    public string? Name { get; set; }

    /// <summary>
    /// The label text for the file upload.
    /// </summary>
    [Parameter]
    public string? Label { get; set; }

    /// <summary>
    /// Additional CSS classes for the label.
    /// </summary>
    [Parameter]
    public string? LabelCssClass { get; set; }

    /// <summary>
    /// Hint text to display below the label.
    /// </summary>
    [Parameter]
    public string? Hint { get; set; }

    /// <summary>
    /// Whether the file upload is disabled.
    /// </summary>
    [Parameter]
    public bool Disabled { get; set; }

    /// <summary>
    /// Whether the field has an error.
    /// </summary>
    [Parameter]
    public bool HasError { get; set; }

    /// <summary>
    /// The error message to display.
    /// </summary>
    [Parameter]
    public string? ErrorMessage { get; set; }

    /// <summary>
    /// The visually hidden text before the error message. Defaults to "Error".
    /// </summary>
    [Parameter]
    public string ErrorMessageVisuallyHiddenText { get; set; } = "Error";

    /// <summary>
    /// The file types to accept.
    /// </summary>
    [Parameter]
    public string? Accept { get; set; }

    /// <summary>
    /// Whether to allow multiple file selection.
    /// </summary>
    [Parameter]
    public bool Multiple { get; set; }

    /// <summary>
    /// Callback for when files are selected.
    /// </summary>
    [Parameter]
    public EventCallback<ChangeEventArgs> OnChange { get; set; }

    /// <summary>
    /// Additional CSS classes to apply to the form group.
    /// </summary>
    [Parameter]
    public string? CssClass { get; set; }

    /// <summary>
    /// Additional CSS classes to apply to the input.
    /// </summary>
    [Parameter]
    public string? InputCssClass { get; set; }

    /// <summary>
    /// Additional HTML attributes to apply to the input.
    /// </summary>
    [Parameter(CaptureUnmatchedValues = true)]
    public Dictionary<string, object>? AdditionalAttributes { get; set; }

    private async Task HandleChange(ChangeEventArgs e)
    {
        await OnChange.InvokeAsync(e);
    }

    private string? GetAriaDescribedBy()
    {
        var parts = new List<string>();
        
        if (!string.IsNullOrWhiteSpace(Hint))
        {
            parts.Add($"{Id}-hint");
        }
        
        if (HasError && !string.IsNullOrWhiteSpace(ErrorMessage))
        {
            parts.Add($"{Id}-error");
        }
        
        return parts.Count > 0 ? string.Join(" ", parts) : null;
    }
}
