@namespace Blazor.DesignSystem.Components
@inject IJSRuntime JSRuntime

<div @ref="_errorSummaryElement"
     class="govuk-error-summary @CssClass" 
     data-module="govuk-error-summary"
     data-disable-auto-focus="@(DisableAutoFocus ? "true" : null)"
     tabindex="-1"
     @attributes="AdditionalAttributes">
    <div role="alert">
        <h2 class="govuk-error-summary__title">
            @Title
        </h2>
        <div class="govuk-error-summary__body">
            @if (!string.IsNullOrWhiteSpace(Description))
            {
                <p>@Description</p>
            }
            @if (DescriptionContent != null)
            {
                <p>@DescriptionContent</p>
            }
            @if (Errors.Any())
            {
                <ul class="govuk-list govuk-error-summary__list">
                    @foreach (var error in Errors)
                    {
                        <li>
                            @if (!string.IsNullOrWhiteSpace(error.FieldId))
                            {
                                <a href="#@error.FieldId" @onclick="@(() => HandleErrorClick(error.FieldId))" @onclick:preventDefault>@error.Message</a>
                            }
                            else
                            {
                                @error.Message
                            }
                        </li>
                    }
                </ul>
            }
        </div>
    </div>
</div>

@code {
    private ElementReference _errorSummaryElement;

    /// <summary>
    /// The error summary title. Defaults to "There is a problem".
    /// </summary>
    [Parameter]
    public string Title { get; set; } = "There is a problem";

    /// <summary>
    /// Optional description text to display before the error list.
    /// </summary>
    [Parameter]
    public string? Description { get; set; }

    /// <summary>
    /// Optional description content (as RenderFragment) to display before the error list.
    /// </summary>
    [Parameter]
    public RenderFragment? DescriptionContent { get; set; }

    /// <summary>
    /// The list of errors to display.
    /// </summary>
    [Parameter]
    public IEnumerable<ErrorItem> Errors { get; set; } = Enumerable.Empty<ErrorItem>();

    /// <summary>
    /// If set to true, the error summary will not be focussed when the page loads.
    /// </summary>
    [Parameter]
    public bool DisableAutoFocus { get; set; }

    /// <summary>
    /// Additional CSS classes to apply.
    /// </summary>
    [Parameter]
    public string? CssClass { get; set; }

    /// <summary>
    /// Additional HTML attributes to apply.
    /// </summary>
    [Parameter(CaptureUnmatchedValues = true)]
    public Dictionary<string, object>? AdditionalAttributes { get; set; }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !DisableAutoFocus && Errors.Any())
        {
            await FocusErrorSummaryAsync();
        }
    }

    /// <summary>
    /// Focuses the error summary element. This can be called programmatically when needed.
    /// </summary>
    public async Task FocusErrorSummaryAsync()
    {
        await JSRuntime.InvokeVoidAsync("GovUkDesignSystem.focusErrorSummary");
    }

    private async Task HandleErrorClick(string? fieldId)
    {
        if (string.IsNullOrWhiteSpace(fieldId))
            return;

        // Scroll the target element into view and focus it
        await JSRuntime.InvokeVoidAsync("GovUkDesignSystem.navigateToField", fieldId);
    }

    /// <summary>
    /// Represents an error item in the error summary.
    /// </summary>
    public class ErrorItem
    {
        /// <summary>
        /// The error message.
        /// </summary>
        public string Message { get; set; } = string.Empty;

        /// <summary>
        /// The ID of the field with the error (for linking).
        /// </summary>
        public string? FieldId { get; set; }
    }
}
